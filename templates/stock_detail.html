{% extends "base.html" %}

{% block title %}{{ symbol }} - StockGenie Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1" style="font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                <i class="bi bi-graph-up me-2"></i>{{ symbol }}
            </h1>
            <p class="text-muted mb-0">Detailed technical analysis and trading signals</p>
        </div>
        <div class="d-flex gap-2">
            <select class="form-select" id="timeframeSelect" onchange="changeTimeframe()" style="width: auto; border-radius: 12px; border: 2px solid #e2e8f0; font-weight: 600;">
                <option value="5min">5 Minutes</option>
                <option value="15min">15 Minutes</option>
                <option value="30min">30 Minutes</option>
                <option value="hour">1 Hour</option>
                <option value="day">Daily</option>
            </select>
            <button class="btn btn-primary" onclick="refreshStock()" style="border-radius: 12px;">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="stockLoading">
        <div class="spinner-border text-primary" role="status" style="width: 3.5rem; height: 3.5rem;"></div>
        <p class="mt-3 text-muted" style="font-weight: 600;">Loading stock data...</p>
    </div>

    <!-- Stock Summary -->
    <div class="row mb-4 g-3" id="stockSummary" style="display: none;">
        <div class="col-md-3 col-sm-6">
            <div class="card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(79, 70, 229, 0.05));">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted" style="font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Current Price</small>
                        <i class="bi bi-currency-rupee" style="color: #6366f1; font-size: 1.25rem; opacity: 0.5;"></i>
                    </div>
                    <h3 id="currentPrice" style="font-weight: 800; color: #6366f1;">--</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.08), rgba(219, 39, 119, 0.05));">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted" style="font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Technical Score</small>
                        <i class="bi bi-speedometer2" style="color: #ec4899; font-size: 1.25rem; opacity: 0.5;"></i>
                    </div>
                    <h3 id="techScore" style="font-weight: 800; color: #ec4899;">--</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.08), rgba(0, 242, 254, 0.05));">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <small class="text-muted" style="font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Volume Ratio</small>
                        <i class="bi bi-bar-chart-line" style="color: #4facfe; font-size: 1.25rem; opacity: 0.5;"></i>
                    </div>
                    <h3 id="volumeRatio" style="font-weight: 800; color: #4facfe;">--</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <small class="text-muted">RSI</small>
                    <h3 id="rsiValue">--</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart and Indicators -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Price Chart</h5>
                </div>
                <div class="card-body">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-white">
                    <h6 class="mb-0">Support & Resistance</h6>
                </div>
                <div class="card-body" id="srLevels">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-white">
                    <h6 class="mb-0">Technical Signals</h6>
                </div>
                <div class="card-body" id="signals">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const symbol = '{{ symbol }}';
    let priceChart;
    let currentTimeframe = '5min';
    
    function initChart() {
        const ctx = document.getElementById('priceChart').getContext('2d');
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Price',
                    data: [],
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return 'â‚¹' + value.toFixed(2);
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    async function refreshStock() {
        showLoading('stockLoading');
        
        try {
            // Fetch stock analysis
            const analysisResponse = await fetch(`/api/stock-analysis/${symbol}?timeframe=${currentTimeframe}`);
            const analysisResult = await analysisResponse.json();
            
            if (analysisResult.success) {
                updateStockData(analysisResult.data);
            }
            
            // Fetch candlestick data
            const candleResponse = await fetch(`/api/candlestick/${symbol}?timeframe=${currentTimeframe}`);
            const candleResult = await candleResponse.json();
            
            if (candleResult.success) {
                updateChart(candleResult.data);
            }
            
            document.getElementById('stockSummary').style.display = 'flex';
        } catch (error) {
            console.error('Error loading stock data:', error);
        } finally {
            hideLoading('stockLoading');
        }
    }
    
    function updateStockData(data) {
        document.getElementById('currentPrice').textContent = formatCurrency(data.current_price);
        document.getElementById('techScore').innerHTML = `<span class="badge bg-primary">${data.score}/100</span>`;
        document.getElementById('volumeRatio').textContent = data.volume_ratio + 'x';
        
        if (data.rsi) {
            const rsiColor = data.rsi < 30 ? 'success' : data.rsi > 70 ? 'danger' : 'secondary';
            document.getElementById('rsiValue').innerHTML = `<span class="text-${rsiColor}">${data.rsi.toFixed(1)}</span>`;
        }
        
        // Update S/R levels
        if (data.support_resistance) {
            const sr = data.support_resistance;
            document.getElementById('srLevels').innerHTML = `
                <div class="mb-2">
                    <small class="text-muted">Resistance 3</small>
                    <div class="text-danger fw-bold">${formatCurrency(sr.r3 || 0)}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Resistance 2</small>
                    <div class="text-danger">${formatCurrency(sr.r2 || 0)}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Resistance 1</small>
                    <div class="text-danger">${formatCurrency(sr.r1 || 0)}</div>
                </div>
                <div class="mb-2 border-top border-bottom py-2">
                    <small class="text-muted">Pivot Point</small>
                    <div class="fw-bold">${formatCurrency(sr.pp || 0)}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Support 1</small>
                    <div class="text-success">${formatCurrency(sr.s1 || 0)}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Support 2</small>
                    <div class="text-success">${formatCurrency(sr.s2 || 0)}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Support 3</small>
                    <div class="text-success fw-bold">${formatCurrency(sr.s3 || 0)}</div>
                </div>
            `;
        }
        
        // Update signals
        if (data.signals) {
            const signalsHtml = Object.entries(data.signals).map(([key, value]) => {
                let badgeClass = 'secondary';
                if (value.includes('bullish') || value === 'oversold' || value === 'high') {
                    badgeClass = 'success';
                } else if (value.includes('bearish') || value === 'overbought') {
                    badgeClass = 'danger';
                } else if (value === 'strong') {
                    badgeClass = 'primary';
                }
                
                return `<span class="badge bg-${badgeClass} me-2 mb-2">${key.toUpperCase()}: ${value}</span>`;
            }).join('');
            
            document.getElementById('signals').innerHTML = signalsHtml;
        }
    }
    
    function updateChart(candles) {
        if (!candles || candles.length === 0) return;
        
        const labels = candles.map(c => {
            const date = new Date(c[0]);
            return date.toLocaleTimeString();
        });
        
        const prices = candles.map(c => c[4]); // Close prices
        
        priceChart.data.labels = labels;
        priceChart.data.datasets[0].data = prices;
        priceChart.update();
    }
    
    function changeTimeframe() {
        currentTimeframe = document.getElementById('timeframeSelect').value;
        refreshStock();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        refreshStock();
    });
</script>
{% endblock %}
