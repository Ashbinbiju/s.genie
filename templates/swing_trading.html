{% extends "base.html" %}

{% block title %}Swing Trading - StockGenie Pro{% endblock %}

{% block extra_css %}
<style>
    /* Clean, modern styles for swing trading page */
    .page-header {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .info-banner {
        background: linear-gradient(to right, #f8f9fa, #ffffff);
        border-left: 4px solid #0d6efd;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stock-opportunity-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    
    .stock-opportunity-card:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .stock-symbol {
        font-size: 1.5rem;
        font-weight: 700;
        color: #212529;
        margin: 0;
    }
    
    .stock-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #0d6efd;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
        margin-right: 0.75rem;
    }
    
    .score-badge {
        background: linear-gradient(135deg, #0d6efd, #0a58ca);
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 10px;
        text-align: center;
        min-width: 90px;
    }
    
    .score-number {
        font-size: 1.75rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.25rem;
    }
    
    .score-label {
        font-size: 0.75rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .price-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.25rem;
    }
    
    .price-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .price-box.entry { border-left: 3px solid #0d6efd; }
    .price-box.target { border-left: 3px solid #198754; }
    .price-box.stop-loss { border-left: 3px solid #dc3545; }
    .price-box.risk-reward { border-left: 3px solid #6c757d; }
    
    .price-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .price-value {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
    }
    
    .price-value.entry-color { color: #0d6efd; }
    .price-value.target-color { color: #198754; }
    .price-value.stop-color { color: #dc3545; }
    .price-value.rr-color { color: #495057; }
    
    .indicators-section {
        margin-bottom: 1.25rem;
    }
    
    .section-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 0.75rem;
        font-weight: 600;
    }
    
    .indicator-badge {
        display: inline-block;
        background: #e7f1ff;
        color: #0a58ca;
        padding: 0.5rem 0.875rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .market-health-badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        text-transform: capitalize;
    }
    
    .market-health-badge.bullish {
        background: #d1f4e0;
        color: #0f5132;
    }
    
    .market-health-badge.bearish {
        background: #f8d7da;
        color: #842029;
    }
    
    .market-health-badge.neutral {
        background: #fff3cd;
        color: #664d03;
    }
    
    .view-details-btn {
        width: 100%;
        padding: 0.75rem;
        font-weight: 600;
        border-radius: 8px;
        border: 2px solid #0d6efd;
        background: white;
        color: #0d6efd;
        transition: all 0.3s ease;
    }
    
    .view-details-btn:hover {
        background: #0d6efd;
        color: white;
    }
    
    .alert-message {
        border-radius: 10px;
        padding: 1.25rem;
        border: none;
        border-left: 4px solid;
    }
    
    .alert-message.success {
        background: #d1f4e0;
        border-left-color: #198754;
        color: #0f5132;
    }
    
    .alert-message.warning {
        background: #fff3cd;
        border-left-color: #ffc107;
        color: #664d03;
    }
    
    .alert-message.error {
        background: #f8d7da;
        border-left-color: #dc3545;
        color: #842029;
    }
    
    .loading-container {
        text-align: center;
        padding: 3rem;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="display-6 fw-bold mb-2">
                    <i class="bi bi-bar-chart text-primary me-2"></i>Swing Trading
                </h1>
                <p class="text-secondary mb-0">Multi-day trading opportunities with strong technical setups</p>
            </div>
            <button class="btn btn-primary btn-lg" onclick="scanSwing()">
                <i class="bi bi-arrow-clockwise me-2"></i>Scan Now
            </button>
        </div>
    </div>

    <!-- Info Banner -->
    <div class="info-banner">
        <div class="d-flex align-items-start">
            <i class="bi bi-info-circle-fill text-primary me-3 fs-5"></i>
            <div>
                <h6 class="fw-bold mb-1">Swing Trading Strategy</h6>
                <p class="mb-0 small text-secondary">
                    Looking for stocks with strong support levels, trending patterns, and favorable risk-reward ratios (minimum 1:2)
                </p>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-container d-none" id="scanLoading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-secondary fw-semibold">Scanning swing opportunities...</p>
    </div>

    <!-- Opportunities Container -->
    <div id="opportunitiesContainer"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2
        }).format(value);
    }

    function showLoading(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.classList.remove('d-none');
        }
    }

    // Pagination state
    let currentPage = 1;
    let totalPages = 1;
    let isFullScan = false;
    let scanInProgress = false;

    function hideLoading(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.classList.add('d-none');
        }
    }

    function showScanProgress(progress) {
        const container = document.getElementById('opportunitiesContainer');
        container.innerHTML = `
            <div class="alert-message info mb-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <strong>Scanning stocks... ${progress.percent}%</strong>
                            <div class="small text-muted">
                                ${progress.current} of ${progress.total} stocks scanned
                                ${progress.opportunities_found ? ` - Found ${progress.opportunities_found} opportunities` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="fs-3 fw-bold text-primary">${progress.percent}%</div>
                </div>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: ${progress.percent}%"
                         aria-valuenow="${progress.percent}" 
                         aria-valuemin="0" 
                         aria-valuemax="100"></div>
                </div>
            </div>
        `;
    }

    async function scanSwing(page = 1, fullScan = false) {
        if (page === 1) {
            showLoading('scanLoading');
        }
        
        currentPage = page;
        isFullScan = fullScan;
        
        try {
            const url = `/api/swing-scan?page=${page}&limit=20&full_scan=${fullScan}`;
            const response = await fetch(url);
            const result = await response.json();
            
            const container = document.getElementById('opportunitiesContainer');
            
            // Handle scan started
            if (result.scan_started || result.scan_in_progress) {
                scanInProgress = true;
                showScanProgress({
                    percent: result.scan_progress || 0,
                    current: result.scanned_count || 0,
                    total: result.total_count || result.total_stocks,
                    opportunities_found: result.data?.length || 0
                });
                
                // Poll for updates if scan just started
                if (result.scan_started) {
                    setTimeout(() => pollScanStatus('swing'), 2000);
                }
                return;
            }
            
            scanInProgress = false;
            
            if (result.success && result.data && result.data.length > 0) {
                totalPages = result.pagination.total_pages;
                
                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="alert-message success">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-check-circle-fill me-3 fs-4"></i>
                                <div>
                                    <strong>Found ${result.pagination.total_items} swing trading opportunities</strong>
                                    <div class="small text-muted">
                                        ${fullScan ? 'Full scan' : 'Quick scan'} - 
                                        Showing ${result.count} results (page ${page} of ${totalPages})
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary ${!fullScan ? 'active' : ''}" 
                                    onclick="scanSwing(1, false)">
                                <i class="bi bi-lightning-fill me-1"></i> Quick Scan
                            </button>
                            <button class="btn btn-outline-primary ${fullScan ? 'active' : ''}" 
                                    onclick="scanSwing(1, true)">
                                <i class="bi bi-search me-1"></i> Full Scan (All Stocks)
                            </button>
                        </div>
                    </div>
                    <div class="row g-4">
                        ${result.data.map((opp, index) => `
                            <div class="col-lg-6">
                                <div class="stock-opportunity-card">
                                    <!-- Stock Header -->
                                    <div class="stock-header">
                                        <div class="d-flex align-items-center">
                                            <span class="stock-number">${(page - 1) * 20 + index + 1}</span>
                                            <div>
                                                <h3 class="stock-symbol">${opp.symbol}</h3>
                                                <span class="market-health-badge ${opp.market_health || 'neutral'}">
                                                    ${opp.market_health || 'neutral'}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="score-badge">
                                            <div class="score-number">${opp.score}</div>
                                            <div class="score-label">Score</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Price Information -->
                                    <div class="price-grid">
                                        <div class="price-box entry">
                                            <div class="price-label">Entry Price</div>
                                            <h5 class="price-value entry-color">${formatCurrency(opp.entry)}</h5>
                                        </div>
                                        <div class="price-box target">
                                            <div class="price-label">Target</div>
                                            <h5 class="price-value target-color">${formatCurrency(opp.target)}</h5>
                                        </div>
                                        <div class="price-box stop-loss">
                                            <div class="price-label">Stop Loss</div>
                                            <h5 class="price-value stop-color">${formatCurrency(opp.stop_loss)}</h5>
                                        </div>
                                        <div class="price-box risk-reward">
                                            <div class="price-label">Risk:Reward</div>
                                            <h5 class="price-value rr-color">1:${opp.risk_reward}</h5>
                                        </div>
                                    </div>
                                    
                                    <!-- Technical Indicators -->
                                    <div class="indicators-section">
                                        <div class="section-title">Technical Indicators</div>
                                        <div>
                                            ${opp.rsi ? `<span class="indicator-badge">RSI: ${opp.rsi.toFixed(1)}</span>` : ''}
                                            ${opp.adx ? `<span class="indicator-badge">ADX: ${opp.adx.toFixed(1)}</span>` : ''}
                                            ${opp.signals ? Object.entries(opp.signals).map(([k, v]) => 
                                                `<span class="indicator-badge">${k}: ${v}</span>`
                                            ).join('') : ''}
                                        </div>
                                    </div>
                                    
                                    <!-- Action Button -->
                                    <a href="/stock-detail/${opp.symbol}" class="view-details-btn text-decoration-none">
                                        View Detailed Analysis <i class="bi bi-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Pagination -->
                    ${totalPages > 1 ? `
                        <div class="d-flex justify-content-center mt-4">
                            <nav aria-label="Page navigation">
                                <ul class="pagination">
                                    <li class="page-item ${!result.pagination.has_prev ? 'disabled' : ''}">
                                        <a class="page-link" href="#" onclick="scanSwing(${page - 1}, ${fullScan}); return false;">
                                            <i class="bi bi-chevron-left"></i> Previous
                                        </a>
                                    </li>
                                    ${Array.from({length: Math.min(5, totalPages)}, (_, i) => {
                                        const pageNum = Math.max(1, page - 2) + i;
                                        if (pageNum > totalPages) return '';
                                        return `
                                            <li class="page-item ${pageNum === page ? 'active' : ''}">
                                                <a class="page-link" href="#" onclick="scanSwing(${pageNum}, ${fullScan}); return false;">
                                                    ${pageNum}
                                                </a>
                                            </li>
                                        `;
                                    }).join('')}
                                    <li class="page-item ${!result.pagination.has_next ? 'disabled' : ''}">
                                        <a class="page-link" href="#" onclick="scanSwing(${page + 1}, ${fullScan}); return false;">
                                            Next <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    ` : ''}
                `;
            } else if (result.success && result.data && result.data.length === 0) {
                container.innerHTML = `
                    <div class="alert-message warning">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                            <strong>No swing trading opportunities found at this time. Try a full scan or check back later.</strong>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error scanning swing trades:', error);
            document.getElementById('opportunitiesContainer').innerHTML = `
                <div class="alert-message error">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-x-circle-fill me-3 fs-4"></i>
                        <strong>Error loading opportunities. Please try again.</strong>
                    </div>
                </div>
            `;
        } finally {
            hideLoading('scanLoading');
        }
    }

    // Poll scan status
    async function pollScanStatus(scanType) {
        if (!scanInProgress) return;
        
        try {
            const response = await fetch('/api/scan-status');
            const status = await response.json();
            
            if (status.scan_in_progress && status.scan_type === scanType) {
                showScanProgress({
                    percent: status.scan_progress,
                    current: status.scanned_count,
                    total: status.total_count,
                    opportunities_found: scanType === 'swing' ? status.swing_opportunities_count : status.intraday_opportunities_count
                });
                
                // Continue polling
                setTimeout(() => pollScanStatus(scanType), 2000);
            } else if (status.scan_status === 'completed') {
                // Scan completed, reload results
                scanInProgress = false;
                scanSwing(currentPage, isFullScan);
            }
        } catch (error) {
            console.error('Error polling scan status:', error);
            setTimeout(() => pollScanStatus(scanType), 5000);
        }
    }

    // WebSocket connection for real-time updates
    if (typeof io !== 'undefined') {
        const socket = io();
        
        socket.on('connect', function() {
            console.log('WebSocket connected');
        });
        
        socket.on('scan_progress', function(data) {
            if (data.type === 'swing' && scanInProgress) {
                showScanProgress(data);
            }
        });
        
        socket.on('scan_complete', function(data) {
            if (data.type === 'swing') {
                scanInProgress = false;
                console.log(`Scan completed in ${data.scan_duration}s - ${data.total_opportunities} opportunities found`);
                // Reload current page
                scanSwing(currentPage, isFullScan);
            }
        });
        
        socket.on('scan_error', function(data) {
            if (data.type === 'swing') {
                scanInProgress = false;
                document.getElementById('opportunitiesContainer').innerHTML = `
                    <div class="alert-message error">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-x-circle-fill me-3 fs-4"></i>
                            <strong>Scan error: ${data.error}</strong>
                        </div>
                    </div>
                `;
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // Start with quick scan
        scanSwing(1, false);
    });
</script>
{% endblock %}
