{% extends "base.html" %}

{% block title %}Market Analysis - StockGenie Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1" style="font-weight: 800; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                <i class="bi bi-graph-up me-2"></i>Market Analysis
            </h1>
            <p class="text-muted mb-0">Comprehensive market health and sector analysis</p>
        </div>
        <button class="btn btn-primary" onclick="refreshMarket()" style="box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
    </div>

    <!-- Market Health Cards -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.05), rgba(0, 242, 254, 0.05));">
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-md-3 text-center">
                            <div class="position-relative">
                                <h6 class="text-muted mb-3" style="font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px;">Market Health</h6>
                                <h2 id="marketStatus" class="mb-2" style="font-weight: 800; font-size: 2rem;">--</h2>
                                <div class="progress mb-3" style="height: 12px; border-radius: 10px;">
                                    <div id="marketProgressBar" class="progress-bar" style="width: 0%; background: linear-gradient(135deg, #4facfe, #00f2fe);"></div>
                                </div>
                                <small id="marketScoreText" style="font-weight: 600; color: #64748b;">Score: --/100</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center" style="border-left: 2px solid rgba(226, 232, 240, 0.5);">
                            <h6 class="text-muted mb-3" style="font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px;">Advance/Decline</h6>
                            <h2 id="adRatio" class="mb-2" style="font-weight: 800; font-size: 2rem;">--%</h2>
                            <div>
                                <span class="badge me-2" style="background: linear-gradient(135deg, #10b981, #059669); padding: 6px 12px; font-weight: 600;">
                                    <i class="bi bi-arrow-up me-1"></i><span id="advCount">--</span>
                                </span>
                                <span class="badge" style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 6px 12px; font-weight: 600;">
                                    <i class="bi bi-arrow-down me-1"></i><span id="decCount">--</span>
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3 text-center" style="border-left: 2px solid rgba(226, 232, 240, 0.5);">
                            <h6 class="text-muted mb-3" style="font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px;">Bullish Sectors</h6>
                            <h2 id="bullishCount" class="mb-2" style="font-weight: 800; font-size: 2rem; color: #10b981;">--</h2>
                            <small id="sectorRatio" style="font-weight: 600; color: #64748b;">-- of -- sectors</small>
                        </div>
                        <div class="col-md-3 text-center" style="border-left: 2px solid rgba(226, 232, 240, 0.5);">
                            <h6 class="text-muted mb-3" style="font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px;">Last Updated</h6>
                            <h2 id="lastUpdateTime" class="mb-2" style="font-weight: 800; font-size: 2rem;">--:--</h2>
                            <small class="text-muted" style="font-weight: 600;">Auto-refresh in <span id="countdown" style="color: #6366f1; font-weight: 700;">--</span>s</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4 g-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(236, 72, 153, 0.05)); border-bottom: 2px solid rgba(99, 102, 241, 0.1);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" style="font-weight: 700;">
                            <i class="bi bi-pie-chart-fill me-2" style="color: #6366f1;"></i>Market Breadth Distribution
                        </h5>
                        <span class="badge bg-light text-dark" style="font-weight: 600;">Live</span>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="breadthPieChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.05), rgba(0, 242, 254, 0.05)); border-bottom: 2px solid rgba(79, 172, 254, 0.1);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" style="font-weight: 700;">
                            <i class="bi bi-bar-chart-fill me-2" style="color: #4facfe;"></i>Top Performing Sectors
                        </h5>
                        <span class="badge bg-light text-dark" style="font-weight: 600;">Live</span>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="sectorBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Bullish Sectors Table -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); border-bottom: 2px solid rgba(16, 185, 129, 0.1);">
                    <h5 class="mb-0" style="font-weight: 700;">
                        <i class="bi bi-fire text-danger me-2"></i>Bullish Sectors
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" style="border-collapse: separate; border-spacing: 0;">
                            <thead style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.03), rgba(236, 72, 153, 0.03));">
                                <tr>
                                    <th style="padding: 1rem 1.5rem; font-weight: 700; border-bottom: 2px solid rgba(226, 232, 240, 0.5);">Sector</th>
                                    <th style="padding: 1rem 1.5rem; font-weight: 700; border-bottom: 2px solid rgba(226, 232, 240, 0.5);">Avg Change %</th>
                                    <th style="padding: 1rem 1.5rem; font-weight: 700; border-bottom: 2px solid rgba(226, 232, 240, 0.5);">Advancing</th>
                                    <th style="padding: 1rem 1.5rem; font-weight: 700; border-bottom: 2px solid rgba(226, 232, 240, 0.5);">Total Stocks</th>
                                    <th style="padding: 1rem 1.5rem; font-weight: 700; border-bottom: 2px solid rgba(226, 232, 240, 0.5);">Strength</th>
                                </tr>
                            </thead>
                            <tbody id="sectorsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status" style="width: 2rem; height: 2rem;">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-3 text-muted" style="font-weight: 600;">Loading sector data...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trending Indices -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up-arrow text-primary me-2"></i>Trending Indices</h5>
                </div>
                <div class="card-body">
                    <div id="indicesContainer" class="row"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let breadthChart, sectorChart;
    let countdownTimer;
    let autoRefreshSeconds = 300; // 5 minutes
    
    function initCharts() {
        const breadthCtx = document.getElementById('breadthPieChart').getContext('2d');
        breadthChart = new Chart(breadthCtx, {
            type: 'doughnut',
            data: {
                labels: ['Advancing', 'Declining', 'Unchanged'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#10b981', '#ef4444', '#6b7280'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
        
        const sectorCtx = document.getElementById('sectorBarChart').getContext('2d');
        sectorChart = new Chart(sectorCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Change %',
                    data: [],
                    backgroundColor: '#4f46e5',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    async function refreshMarket() {
        try {
            const response = await fetch('/api/market-health');
            const result = await response.json();
            
            if (result.success) {
                updateMarketHealth(result.data);
                startCountdown();
            }
        } catch (error) {
            console.error('Error refreshing market data:', error);
        }
    }
    
    function updateMarketHealth(data) {
        const health = data.health;
        const sectors = data.bullish_sectors;
        const indices = data.trending_indices;
        
        // Update market status
        const statusEl = document.getElementById('marketStatus');
        statusEl.textContent = health.health.toUpperCase();
        statusEl.className = `mb-2 text-${health.health === 'bullish' ? 'success' : health.health === 'bearish' ? 'danger' : 'warning'}`;
        
        // Update progress bar
        const progressBar = document.getElementById('marketProgressBar');
        progressBar.style.width = health.score + '%';
        progressBar.className = `progress-bar bg-${health.health === 'bullish' ? 'success' : health.health === 'bearish' ? 'danger' : 'warning'}`;
        
        document.getElementById('marketScoreText').textContent = `Score: ${health.score}/100`;
        
        // Update A/D stats
        document.getElementById('adRatio').textContent = health.ad_ratio + '%';
        document.getElementById('advCount').textContent = '▲ ' + health.advancing;
        document.getElementById('decCount').textContent = '▼ ' + health.declining;
        
        // Update sectors
        document.getElementById('bullishCount').textContent = health.positive_sectors;
        document.getElementById('sectorRatio').textContent = `${health.positive_sectors} of ${health.total_sectors} sectors`;
        
        // Update timestamp
        const now = new Date();
        document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString();
        
        // Update charts
        breadthChart.data.datasets[0].data = [
            health.advancing,
            health.declining,
            health.total - health.advancing - health.declining
        ];
        breadthChart.update();
        
        if (sectors.length > 0) {
            const topSectors = sectors.slice(0, 8);
            sectorChart.data.labels = topSectors.map(s => s.name);
            sectorChart.data.datasets[0].data = topSectors.map(s => s.change);
            sectorChart.update();
            
            // Update sectors table
            const tableBody = document.getElementById('sectorsTableBody');
            tableBody.innerHTML = sectors.map(sector => {
                const strength = (sector.advancing / sector.total * 100).toFixed(1);
                return `
                    <tr>
                        <td><strong>${sector.name}</strong></td>
                        <td><span class="badge bg-success">+${sector.change.toFixed(2)}%</span></td>
                        <td>${sector.advancing}</td>
                        <td>${sector.total}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: ${strength}%">
                                    ${strength}%
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update trending indices
        if (indices && indices.length > 0) {
            const indicesContainer = document.getElementById('indicesContainer');
            indicesContainer.innerHTML = indices.map(idx => `
                <div class="col-md-3 mb-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted mb-2">${idx.index}</h6>
                            <h4 class="mb-2">${formatCurrency(idx.price)}</h4>
                            <div class="d-flex justify-content-between">
                                <small class="${idx.change_percent >= 0 ? 'text-success' : 'text-danger'}">
                                    ${idx.change_percent >= 0 ? '▲' : '▼'} ${Math.abs(idx.change_percent).toFixed(2)}%
                                </small>
                                <small class="text-muted">Momentum: ${idx.momentum.toFixed(1)}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }
    
    function startCountdown() {
        let seconds = autoRefreshSeconds;
        if (countdownTimer) clearInterval(countdownTimer);
        
        countdownTimer = setInterval(() => {
            seconds--;
            document.getElementById('countdown').textContent = seconds;
            
            if (seconds <= 0) {
                refreshMarket();
            }
        }, 1000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        refreshMarket();
    });
</script>
{% endblock %}
